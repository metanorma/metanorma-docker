FROM ${ROOT_IMAGE}
USER root

MAINTAINER Open Source at Ribose <open.source@ribose.com>

# install dependencies
RUN apt-get update && apt-get install -y curl gnupg2 software-properties-common
RUN mkdir -p /usr/share/man/man1 # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=863199
RUN curl -sSL https://raw.githubusercontent.com/metanorma/metanorma-linux-setup/master/ubuntu.sh | bash -s

# install xml2rfc
RUN pip install --upgrade pip
RUN pip install idnits xml2rfc --ignore-installed six chardet

# install latest bundler
RUN gem install bundler

# install metanorma toolchain
RUN mkdir -p /setup
COPY ${METANORMA_IMAGE_NAME}/Gemfile /setup/Gemfile
RUN cd /setup && bundle install

# export java executable path
ENV JAVA_HOME /usr/lib/jvm/default-java
ENV PATH $PATH:$JAVA_HOME/bin
ENV RUBYOPT -rbundler/setup
ENV BUNDLE_GEMFILE /setup/Gemfile

# cleanup and set base entrypoint
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# load NVM
ENV NVM_DIR "/root/.nvm"
ENV NODE_PATH "$NVM_DIR/versions/node/v12.4.0/lib/node_modules"
ENV PATH "$PATH:$NVM_DIR/versions/node/v12.4.0/bin"

WORKDIR /metanorma
CMD metanorma